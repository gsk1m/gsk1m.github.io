<!DOCTYPE html>
<html lang="en">

<head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<link rel="stylesheet" href="/assets/css/style.css">
<link rel="stylesheet" href="/assets/css/academicons-1.9.2/css/academicons.css">
<link rel="stylesheet" href="/assets/css/fontawesome-free-6.1.1-web/css/all.css">
<link href="https://fonts.googleapis.com/css?family=Merriweather:300|Raleway:400,700" rel="stylesheet">

<title>ğŸŒˆ [SymForce Tutorial 3í¸] Pose-graph Optimization ì‹¤ìŠµ (Toy Example)</title>

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>ğŸŒˆ [SymForce Tutorial 3í¸] Pose-graph Optimization ì‹¤ìŠµ (Toy Example) | Giseop Kim Blog</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="ğŸŒˆ [SymForce Tutorial 3í¸] Pose-graph Optimization ì‹¤ìŠµ (Toy Example)" />
<meta name="author" content="Giseop Kim" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Pose-graph optimization ì´ë€? ê³„ì‚° íš¨ìœ¨ì„±ì„ ë†’ì´ê¸° ìœ„í•´ Landmark ë¥¼ state vector ì—ì„œ ì œì™¸í•˜ëŠ” ì‹œë„ë“¤ì´ 2000ë…„ëŒ€ í›„ë°˜ SLAM í•™ê³„ì—ì„œ ì´ì–´ì¡Œë‹¤. ê·¸ë¦¬ê³  3D ì •ë³´ë¥¼ ì§ì ‘ ì •êµí•˜ê²Œ ì¸¡ì •í•˜ëŠ” LiDAR sensor ê°€ ëŒ€ì¤‘í™”ë˜ë©°, ambiguous landmarkë¥¼ êµ³ì´ ìµœì í™”í•  í•„ìš” ì—†ì´, ë¡œë´‡ì˜ poseë§Œì„ ìµœì í™” í•˜ëŠ” ê²ƒì´ ë”ìš± ëŒ€ì¤‘í™”ëœ ë“¯í•˜ë‹¤. SymForce ë¥¼ ì´ìš©í•´ì„œ Pose-graph Optimizationì„ êµ¬í˜„í•´ë³´ì." />
<meta property="og:description" content="Pose-graph optimization ì´ë€? ê³„ì‚° íš¨ìœ¨ì„±ì„ ë†’ì´ê¸° ìœ„í•´ Landmark ë¥¼ state vector ì—ì„œ ì œì™¸í•˜ëŠ” ì‹œë„ë“¤ì´ 2000ë…„ëŒ€ í›„ë°˜ SLAM í•™ê³„ì—ì„œ ì´ì–´ì¡Œë‹¤. ê·¸ë¦¬ê³  3D ì •ë³´ë¥¼ ì§ì ‘ ì •êµí•˜ê²Œ ì¸¡ì •í•˜ëŠ” LiDAR sensor ê°€ ëŒ€ì¤‘í™”ë˜ë©°, ambiguous landmarkë¥¼ êµ³ì´ ìµœì í™”í•  í•„ìš” ì—†ì´, ë¡œë´‡ì˜ poseë§Œì„ ìµœì í™” í•˜ëŠ” ê²ƒì´ ë”ìš± ëŒ€ì¤‘í™”ëœ ë“¯í•˜ë‹¤. SymForce ë¥¼ ì´ìš©í•´ì„œ Pose-graph Optimizationì„ êµ¬í˜„í•´ë³´ì." />
<link rel="canonical" href="http://localhost:4000/slam/2022/07/31/pgo-toy.html" />
<meta property="og:url" content="http://localhost:4000/slam/2022/07/31/pgo-toy.html" />
<meta property="og:site_name" content="Giseop Kim Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-07-31T12:00:00+09:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="ğŸŒˆ [SymForce Tutorial 3í¸] Pose-graph Optimization ì‹¤ìŠµ (Toy Example)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Giseop Kim"},"dateModified":"2022-07-31T12:00:00+09:00","datePublished":"2022-07-31T12:00:00+09:00","description":"Pose-graph optimization ì´ë€? ê³„ì‚° íš¨ìœ¨ì„±ì„ ë†’ì´ê¸° ìœ„í•´ Landmark ë¥¼ state vector ì—ì„œ ì œì™¸í•˜ëŠ” ì‹œë„ë“¤ì´ 2000ë…„ëŒ€ í›„ë°˜ SLAM í•™ê³„ì—ì„œ ì´ì–´ì¡Œë‹¤. ê·¸ë¦¬ê³  3D ì •ë³´ë¥¼ ì§ì ‘ ì •êµí•˜ê²Œ ì¸¡ì •í•˜ëŠ” LiDAR sensor ê°€ ëŒ€ì¤‘í™”ë˜ë©°, ambiguous landmarkë¥¼ êµ³ì´ ìµœì í™”í•  í•„ìš” ì—†ì´, ë¡œë´‡ì˜ poseë§Œì„ ìµœì í™” í•˜ëŠ” ê²ƒì´ ë”ìš± ëŒ€ì¤‘í™”ëœ ë“¯í•˜ë‹¤. SymForce ë¥¼ ì´ìš©í•´ì„œ Pose-graph Optimizationì„ êµ¬í˜„í•´ë³´ì.","headline":"ğŸŒˆ [SymForce Tutorial 3í¸] Pose-graph Optimization ì‹¤ìŠµ (Toy Example)","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/slam/2022/07/31/pgo-toy.html"},"url":"http://localhost:4000/slam/2022/07/31/pgo-toy.html"}</script>
<!-- End Jekyll SEO tag -->


<script type="text/javascript" src="/assets/js/darkmode.js"></script>


<!-- fabicon -->
<link rel="icon" type="image/png" href="/assets/icon/me.png">
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        TeX: {
          equationNumbers: {
            autoNumber: "AMS"
          }
        },
        tex2jax: {
        inlineMath: [ ['$', '$'] ],
        displayMath: [ ['$$', '$$'] ],
        processEscapes: true,
      }
    });
MathJax.Hub.Register.MessageHook("Math Processing Error",function (message) {
        alert("Math Processing Error: "+message[1]);
    });
MathJax.Hub.Register.MessageHook("TeX Jax - parse error",function (message) {
        alert("Math Processing Error: "+message[1]);
    });
</script>
<script type="text/javascript" async
    src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
    
</head><body>
  <main class="container">
    <section class="about">
      <div class="about-header condensed">
      <div class="about-title">
      <a href="/">
        
        <img src="/assets/giseopkim_thermal.png" alt="Giseop Kim" />
        
      </a>
      <h2 id="title">
        <a href="/">Giseop Kim</a>
      </h2>
      </div><p class="tagline">SLAM Engineer</p></div>
      
      <ul class="social about-footer condensed"><a href="https://www.linkedin.com/in/giseop-kim-71683088" target="_blank">
          <li>
            <i class="icon-linkedin-squared"></i>
          </li>
        </a><a href="https://scholar.google.com/citations?user=9mKOLX8AAAAJ&hl=ko&oi=ao" target="_blank">
          <li>
            <i class="ai ai-google-scholar"></i>
          </li>
        </a><a href="https://github.com/gisbi-kim" target="_blank">
          <li>
            <i class="icon-github-circled"></i>
          </li>
        </a><a href="https://bit.ly/giseopkim" target="_blank">
          <li>
            <i class="fa fa-user" style="font-size: 2.09em;"></i>
            <!-- <i> notion</i> -->
            <!-- <i class="fa fa-user"></i> -->
          </li>
        </a><a href="https://youtube.com/channel/UCrmVMJ3KEFbDD9EtnAmDT6g" target="_blank">
          <li>
            <i class="icon-youtube"></i>
          </li>
        </a></ul><p class="about-footer condensed">&copy;
        2022</p><div class="about-footer condensed">
        <p>Dark Mode
          <i class="icon-moon"></i>
          <label class="switch">
            <input type="checkbox" class="dark-mode-toggle">
            <span class="slider round" onclick="toggleDarkMode()"></span>
          </label>
        </p>
      </div>
    </section>
    <section class="content">
      <div class="post-container">
  <a class="post-link" href="/slam/2022/07/31/pgo-toy.html">
    <h2 class="post-title">ğŸŒˆ [SymForce Tutorial 3í¸] Pose-graph Optimization ì‹¤ìŠµ (Toy Example)</h2>
  </a>
  <hr style="border:1px foo rgb(193, 198, 200)">
  <div class="post-meta">
    <div class="post-date"><i class="icon-calendar"></i>Jul 31, 2022</div><ul class="post-categories"><li>SLAM</li></ul></div>
  <div class="post">
    <h1 id="pose-graph-optimization-ì´ë€">Pose-graph optimization ì´ë€?</h1>
<ul>
  <li>ê³„ì‚° íš¨ìœ¨ì„±ì„ ë†’ì´ê¸° ìœ„í•´ Landmark ë¥¼ state vector ì—ì„œ ì œì™¸í•˜ëŠ” ì‹œë„ë“¤ì´ 2000ë…„ëŒ€ í›„ë°˜ SLAM í•™ê³„ì—ì„œ ì´ì–´ì¡Œë‹¤.</li>
  <li>ê·¸ë¦¬ê³  3D ì •ë³´ë¥¼ ì§ì ‘ ì •êµí•˜ê²Œ ì¸¡ì •í•˜ëŠ” LiDAR sensor ê°€ ëŒ€ì¤‘í™”ë˜ë©°, ambiguous landmarkë¥¼ êµ³ì´ ìµœì í™”í•  í•„ìš” ì—†ì´, ë¡œë´‡ì˜ poseë§Œì„ ìµœì í™” í•˜ëŠ” ê²ƒì´ ë”ìš± ëŒ€ì¤‘í™”ëœ ë“¯í•˜ë‹¤.</li>
  <li>SymForce ë¥¼ ì´ìš©í•´ì„œ Pose-graph Optimizationì„ êµ¬í˜„í•´ë³´ì.</li>
</ul>

<h2 id="why-symforce-for-pgo">Why SymForce for PGO?</h2>
<ul>
  <li>ì‚¬ì‹¤ Pose-graph optimization ì— ëŒ€í•´ì„œëŠ” GTSAMì—ì„œ ì´ë¯¸ ê·¸ ê¸°ëŠ¥ì„ (APIë„ ì“°ê¸° ì‰½ê²Œ) ë„ˆë¬´ ì˜ ì œê³µí•˜ê³  ìˆê¸° ë•Œë¬¸ì— ìƒˆë¡œìš´ libraryê°€ êµ³ì´ í•„ìš”í•´? ë¼ëŠ” ìƒê°ì´ ë“¤ê¸°ë„ í•œë‹¤.
    <ul>
      <li>LIO-SAMì´ ê·¸ì¤‘ ê°€ì¥ ìœ ëª…í•œ GTSAMì„ PGOì— ì‚¬ìš©í•œ ì˜ˆì‹œì´ë‹¤ (ê±°ì˜ starë„ ì´ì œ 2ì²œê°œê°€ ë‹¤ ë˜ì–´ ê°„ë‹¤).
        <ul>
          <li>https://github.com/TixiaoShan/LIO-SAM ì—ì„œ <code class="language-plaintext highlighter-rouge">mapOptmization.cpp</code> ì„ ë³´ë©´ëœë‹¤.</li>
        </ul>
      </li>
      <li>í•˜ì§€ë§Œ ë³´í†µ ì´ë ‡ê²Œ ë˜ë©´ ì—”ì§€ë‹ˆì–´ê°€ í• ì¼ì€ ë§¤ìš° ì¶”ìƒí™”ë˜ê²Œ ëœë‹¤.
        <ol>
          <li><code class="language-plaintext highlighter-rouge">isam = new ISAM2(parameters);</code>ë¥¼ ì„ ì–¸í•˜ê³ ,</li>
          <li><code class="language-plaintext highlighter-rouge">gtSAMgraph.add(some factor)</code> í•˜ê³ ,</li>
          <li><code class="language-plaintext highlighter-rouge">isam-&gt;update(gtSAMgraph, initialEstimate);</code> í•˜ëŠ” ì‹ì´ë‹¤ ..</li>
        </ol>
      </li>
      <li>ê·¸ë˜ì„œ ë‚´ë¶€ì ìœ¼ë¡œ ì–´ë–»ê²Œ ì‹¤ì œë¡œ ìµœì í™”ê°€ ì´ë£¨ì–´ì§€ëŠ”ì§€ ì–´ì§€ê°„í•œ ì—´ì •ì´ ì—†ìœ¼ë©´ ëª¨ë¥´ê³  ì“°ê²Œ ëœë‹¤.
        <ul>
          <li>ë‚´ ì–˜ê¸°ë‹¤ ..</li>
        </ul>
      </li>
      <li>GTSAMì€ C++ì—ì„œ custom loss ë¥¼ ì‘ì„±í•  ìˆ˜ ìˆì§€ë§Œ Ceresì— ë¹„í•´ ê³µê°œëœ êµ¬í˜„ì²´ë‚˜ docs ê°€ ì ì€ ëŠë‚Œì´ë‹¤. ê·¸ë˜ì„œ ê¸°ì¡´ built-in cost ë“¤ì˜ êµ¬í˜„ì„ í†ºì•„ë³´ë©° ë”°ë¼ ì‘ì„±í•´ì•¼ í–ˆê³  .. ê·¸ë¦¬ê³  ì™ ì§€ ë­”ê°€ ë‚´ë¶€êµ¬ì¡°ë¥¼ ì¢€ ì•Œê¸°ê°€ ì–´ë µë‹¤ëŠ” ì¸ìƒì´ ìˆì—ˆë‹¤. ë‚´ë¶€ì ìœ¼ë¡œëŠ” traits ê³¼ Template ìœ¼ë¡œ ë³µì¡í•˜ê²Œ ì§œì—¬ì ¸ìˆëŠ”ë° .. íŒŒì•…í•˜ê¸°ê°€ ì¢€ ë³µì¡í•˜ë‹¤.</li>
      <li>ë°˜ë©´ SymForceëŠ” Jacobian ì„ Symbolic í•˜ê²Œ ê³„ì‚°í•´ì„œ ë³´ì—¬ì£¼ë¯€ë¡œ ëª…í™•í•œ ì¸ìƒì´ ìˆë‹¤..
        <ul>
          <li><a href="/slam/2022/07/10/symforce_icp.html">ì•ì˜ ë¸”ë¡œê·¸ íŠœí† ë¦¬ì–¼</a> ì—ì„œ Symforce ê°€ êµ¬í•´ì¤€ Jacobainì„ ê°€ì ¸ë‹¤ ì‚¬ìš©í•´ì„œ ì§ì ‘ Gauss-Newton iteration ì„ êµ¬ì„±í•´ë³¼ ìˆ˜ ìˆì—ˆë‹¤.</li>
          <li>ë¬´ì—‡ë³´ë‹¤ python ì—ì„œë„ custom loss ë¥¼ ì‰½ê²Œ ì‘ì„±í•  ìˆ˜ ìˆì–´ì„œ ì´ê²ƒì €ê²ƒ í•´ë³´ê¸°ê°€ ì¢‹ì€ë“¯ í•˜ë‹¤.</li>
        </ul>
      </li>
      <li>ps. í•œí¸, GTSAM ì„ ì‚¬ìš©í•˜ëŠ” ê·¸ë£¹ì´ ëª‡ ìˆì—ˆê³ , ê·¸ ì™¸ì—ëŠ” ëŒ€ì²´ë¡œ Ceres ë¥¼ ë§ì´ë“¤ ì‚¬ìš©í•˜ëŠ” ë“¯í•˜ë‹¤. Ceres ë¡œ PGOë¥¼ êµ¬í˜„í•œ ê°€ì¥ ìœ ëª…í•œ ì‚¬ë¡€ëŠ” ì•„ë§ˆ VINS-monoì¼ ê²ƒì´ë‹¤.
        <ul>
          <li><code class="language-plaintext highlighter-rouge">https://github.com/HKUST-Aerial-Robotics/VINS-Mono/tree/master/pose_graph</code> ì—¬ê¸°ë¥¼ ë³´ë©´ëœë‹¤.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>ê·¸ë˜ì„œ SymForce tutorial ì°¨ì›ì—ì„œ ì´ê²ƒì €ê²ƒ ì‘ì„±í•´ë³´ê³  ìˆë‹¤.
    <ul>
      <li>Iterative optimizatinoì„ From scratch ë¡œ êµ¬í˜„í•˜ëŠ” ê²ƒì€ ì§€ë‚œ í¬ìŠ¤íŒ…ì—ì„œ í•´ë³´ì•˜ê³ , <a href="/slam/2022/07/10/symforce_icp.html#todo">ì•ì˜ ë¸”ë¡œê·¸ íŠœí† ë¦¬ì–¼ì˜ todo</a> ì—ì„œ ì–˜ê¸°í–ˆë“¯ SymForce ê°€ ì œê³µí•˜ëŠ” optimizer class ë¥¼ ì‚¬ìš©í•´ë³´ì.</li>
      <li>ê´€ë ¨ ì˜ˆì‹œëŠ” landmark ë¥¼ bearing measurement ë¡œ ì¸¡ì •í•´ì„œ global localization ì„ ìˆ˜í–‰í•˜ëŠ” ê²ƒì´ <a href="https://github.com/symforce-org/symforce#solve-the-problem">ê³µì‹readme ì—</a> ìˆë‹¤.</li>
      <li>PGOê°€ ë”± ìˆì§€ëŠ” ì•Šì€ë° ì–´ì§œí”¼ êµ¬ì¡°ëŠ” ë¹„ìŠ·í•˜ë‹ˆê¹Œ ì§ì ‘ ì‘ì„±í•´ë³´ì.</li>
    </ul>
  </li>
</ul>

<h2 id="symforceê¸°ë°˜ì˜-pgo-êµ¬í˜„">SymForceê¸°ë°˜ì˜ PGO êµ¬í˜„</h2>
<ul>
  <li><a href="https://github.com/gisbi-kim/symforce-tutorials/blob/main/pgo/1_pgo3d_toy/pose_graph_opt_3d_toy.ipynb">ì—¬ê¸°ì— ì „ì²´ ì‹¤ìŠµ ì½”ë“œ</a>ê°€ ìˆë‹¤.</li>
</ul>

<h3 id="cost-functions">Cost functions</h3>
<ul>
  <li>PGOì—ì„œ ì‚¬ìš©í•˜ëŠ” cost function ì€ (ìµœì†Œí•œìœ¼ë¡œ) prior ì™€ odometry, loop closure ê°€ ìˆë‹¤.</li>
  <li>SymForce ë¡œëŠ” ë‹¤ìŒê³¼ ê°™ì´ êµ¬í˜„ëœë‹¤.
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">eps</span> <span class="o">=</span> <span class="mf">0.000001</span>

  <span class="k">def</span> <span class="nf">prior_residual</span><span class="p">(</span>
          <span class="n">pose</span>    <span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">Pose3</span><span class="p">,</span> 
          <span class="n">pose_prior</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">Pose3</span><span class="p">,</span>
          <span class="n">diagonal_sigmas</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">V6</span> 
      <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sf</span><span class="o">.</span><span class="n">V6</span><span class="p">:</span>

      <span class="n">tangent_error</span> <span class="o">=</span> <span class="n">pose</span><span class="o">.</span><span class="n">local_coordinates</span><span class="p">(</span><span class="n">pose_prior</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="n">eps</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">sfT</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">V6</span><span class="p">,</span> <span class="n">sf</span><span class="o">.</span><span class="n">M</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">diagonal_sigmas</span><span class="o">.</span><span class="n">to_flat_list</span><span class="p">())</span><span class="o">.</span><span class="n">inv</span><span class="p">()</span> <span class="o">*</span> <span class="n">sf</span><span class="o">.</span><span class="n">V6</span><span class="p">(</span><span class="n">tangent_error</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">odometry_residual</span><span class="p">(</span>
          <span class="n">pose_prev</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">Pose3</span><span class="p">,</span> 
          <span class="n">pose_next</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">Pose3</span><span class="p">,</span> 
          <span class="n">movement</span> <span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">Pose3</span><span class="p">,</span>
          <span class="n">diagonal_sigmas</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">V6</span><span class="p">,</span>
      <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sf</span><span class="o">.</span><span class="n">V6</span><span class="p">:</span>
        
      <span class="c1"># The original reference of the below lines 
</span>      <span class="c1">#  - see https://github.com/symforce-org/symforce/blob/main/symforce/examples/robot_3d_localization/robot_3d_localization.py#L63
</span>      <span class="n">movement_predicted</span> <span class="o">=</span> <span class="n">pose_prev</span><span class="o">.</span><span class="n">inverse</span><span class="p">()</span> <span class="o">*</span> <span class="n">pose_next</span>
      <span class="n">tangent_error</span> <span class="o">=</span> <span class="n">movement_predicted</span><span class="o">.</span><span class="n">local_coordinates</span><span class="p">(</span><span class="n">movement</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="n">eps</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">sfT</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">V6</span><span class="p">,</span> <span class="n">sf</span><span class="o">.</span><span class="n">M</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">diagonal_sigmas</span><span class="o">.</span><span class="n">to_flat_list</span><span class="p">())</span><span class="o">.</span><span class="n">inv</span><span class="p">()</span> <span class="o">*</span> <span class="n">sf</span><span class="o">.</span><span class="n">V6</span><span class="p">(</span><span class="n">tangent_error</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">loop_residual</span><span class="p">(</span>
          <span class="n">pose_prev</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">Pose3</span><span class="p">,</span> 
          <span class="n">pose_next</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">Pose3</span><span class="p">,</span> 
          <span class="n">movement</span> <span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">Pose3</span><span class="p">,</span>
          <span class="n">diagonal_sigmas</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">V6</span><span class="p">,</span>
      <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sf</span><span class="o">.</span><span class="n">V6</span><span class="p">:</span>

      <span class="k">return</span> <span class="n">odometry_residual</span><span class="p">(</span><span class="n">pose_prev</span><span class="p">,</span> <span class="n">pose_next</span><span class="p">,</span> <span class="n">movement</span><span class="p">,</span> <span class="n">diagonal_sigmas</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
  <li>ì„¤ëª…
    <ol>
      <li>prior ëŠ” pose ì˜ SE(3)ì„ direct ë¡œ ì¶”ì •í•˜ëŠ” unary factor (ì¸ìˆ˜ê°€ í•˜ë‚˜ë§Œ ì“°ì¸ë‹¤ëŠ” ëœ») ì´ë‹¤.</li>
      <li>odometry ëŠ” consecutive í•œ node ì‚¬ì´ì˜ motion ì„ ì œì•½í•œë‹¤.
        <ul>
          <li>ë”°ë¼ì„œ pose $i$ ì™€ pose $i+1$ ì‚¬ì´ì˜ ì˜ˆì¸¡ëœ ê°’ (motion model) ì´ ì‹¤ì œë¡œ ì¸¡ì •ëœ ê°’ (measurement)ê³¼ ì¼ì¹˜ë˜ë„ë¡ pose $i$ì™€ $i+1$ ì˜ ìœ„ì¹˜ê°€ ì¡°ì •ëœë‹¤.
            <ul>
              <li>ì´ëŸ° íŠ¹ì„± ë•Œë¬¸ì— GTSAMì—ì„œëŠ” ì´ë¥¼ between factor ë¼ê³  ì¹­í•˜ê¸°ë„ í•œë‹¤.</li>
            </ul>
          </li>
          <li>ì¦‰, ë‘˜ ì‚¬ì´ì˜ relative í•œ ì œì•½ë§Œì„ ë§Œì¡±í•˜ë©´ ë˜ê¸° ë•Œë¬¸ì— ë‘ ë…¸ë“œì˜ ì „ì—­ì ì¸ ìœ„ì¹˜ ìì²´ëŠ” ì–´ë””ì— ë†“ì—¬ìˆë“  ìƒê´€ì´ ì—†ê²Œ ëœë‹¤.
            <ul>
              <li>ì˜ˆë¥¼ ë“¤ì–´, ë‘ ë…¸ë“œê°€ 1ê³¼ 2ì— ìˆì–´ë„ ê·¸ ì‚¬ì´ ê°„ê²©ì€ 1ì´ê³ , 2ì™€ 3ì— ìˆì–´ë„ ê·¸ ì‚¬ì´ ê°„ê²©ì€ 1ì´ë¯€ë¡œ ì—¬ì „íˆ ì œì•½ì„ ë§Œì¡±í•œë‹¤.</li>
              <li>ë”°ë¼ì„œ ìµœì†Œí•œì˜ prior ê°€ í•„ìš”í•˜ë©° ë³´í†µ SLAMì—ì„œëŠ” ì²« node ì— ì•„ì£¼ ê°•í•œ (==ë§¤ìš° ì‘ì€ covarianceë¥¼ ê°€ì§€ëŠ”) prior ì œì•½ì„ ê±¸ì–´ì£¼ê²Œ ëœë‹¤.</li>
              <li>í˜¹ì€ GPS ê°™ì€ ê°’ì„ ì‚¬ìš©í•˜ì—¬ ì „ì—­ì ì¸ ìœ„ì¹˜ë¥¼ ê³ ì •í•  ìˆ˜ë„ ìˆë‹¤.
                <ul>
                  <li>rotation ì •ë³´ê°€ ì—†ì´ translation (ì¦‰, lat, lng, altitude) ë§Œ ì‚¬ìš©ê°€ëŠ¥í•œ ê²½ìš°, í•˜ë‚˜ì˜ node ë§Œ prior ë¥¼ ê±¸ì–´ì£¼ëŠ” ê²ƒìœ¼ë¡œëŠ” ë¶€ì¡±í•˜ê³  ë‘˜ ì´ìƒì˜ ì„œë¡œ ë‹¤ë¥¸ ë…¸ë“œì— prior ë¥¼ ê±¸ì–´ì£¼ì–´ì•¼ global heading ì„ ì•Œ ìˆ˜ ìˆê²Œ ëœë‹¤.</li>
                </ul>
              </li>
              <li>ps. ë§Œì•½ prior ë¥¼ ì•ˆê±¸ì–´ì£¼ë©´ ì´ ë…¸ë“œë“¤ì´ ëª¨ì–‘ìƒˆëŠ” ìœ ì§€í•˜ë©´ì„œ ì „ì—­ì ìœ¼ë¡œ ë¯¸ì³ë‚ ë›°ê²Œ (â€¦) ë˜ëŠ”ë°, ì´ë¥¼ ê²Œì´ì§€ í”„ë¼ë¸”ëŸ¼ ì´ë¼ê³ ë„ í•˜ëŠ” ë“¯í•˜ë‹¤. <a href="https://ceres-solver.googlesource.com/ceres-solver/+/master/examples/slam/pose_graph_3d/pose_graph_3d.cc#89">Ceres ì˜ ê³µì‹ example</a> ì—ì„œë„ ë”± ì´ ì´ì•¼ê¸°ê°€ ìˆë‹¤.
                <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// The pose graph optimization problem has six DOFs that are not fully
// constrained. This is typically referred to as gauge freedom. You can apply
// a rigid body transformation to all the nodes and the optimization problem
// will still have the exact same cost. The Levenberg-Marquardt algorithm has
// internal damping which mitigates this issue, but it is better to properly
// constrain the gauge freedom. This can be <span class="k">done </span>by setting one of the poses
// as constant so the optimizer cannot change it.
</code></pre></div>                </div>
              </li>
            </ul>
          </li>
        </ul>
      </li>
      <li>loop closure ëŠ” not consecutive í•œ ë‘ node ì‚¬ì´ì˜ motionì„ ì œì•½í•œë‹¤.
        <ul>
          <li>ë”°ë¼ì„œ ìˆ˜í•™ì ìœ¼ë¡œëŠ” odometry ì™€ ì™„ì „íˆ ë™ì¼í•˜ë‹¤.
            <ul>
              <li>ê·¸ë˜ì„œ ìœ„ì˜ êµ¬í˜„ì—ì„œë„ <code class="language-plaintext highlighter-rouge">loop_residual</code> ì—ì„œëŠ” ë‚´ë¶€ì ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">odometry_residual</code> ì„ callí•˜ë„ë¡ êµ¬í˜„í•˜ì˜€ë‹¤.</li>
            </ul>
          </li>
          <li>ë‹¤ë§Œ ë¶„ë¦¬í•´ì„œ ì´ì•¼ê¸°í•˜ëŠ” ê²ƒì´ ì¢‹ì€ ì´ìœ ëŠ”,
            <ul>
              <li>odometryì™€ loop closure ì—ëŠ” noise scale ì„ ë‹¤ë¥´ê²Œ ì ìš©í•˜ëŠ” ê²ƒì´ í˜„ì‹¤ ë¬¸ì œë¥¼ í’€ ë•Œì— ë„ì›€ì´ ë˜ê¸° ë•Œë¬¸ì´ë‹¤.
                <ul>
                  <li>ì´ëŠ” ë³¸ì¸ì´ ì‚¬ìš©í•˜ëŠ” ì„¼ì„œì˜ í’ˆì§ˆì— ë”°ë¼ ë‹¬ë¦¬ ì ìš©í•´ì•¼ í•œë‹¤. ì˜ˆë¥¼ ë“¤ì–´ odometryë¡œ wheel odometer ë¥¼ ì‚¬ìš©í•˜ëŠ”ë° ê·¸ê²ƒì˜ í’ˆì§ˆì´ ì¢‹ì§€ ì•Šë‹¤ë©´ odometry residualì— ëŒ€í•´ì„œëŠ” ë†’ì€ noise ë¥¼ ë¶€ì—¬í•  ìˆ˜ ìˆê² ë‹¤. ë°˜ë©´, ê³ ì •ë°€ì˜ lidar ì„¼ì„œ scan ì„ í†µí•´ loop closing ì„ ìˆ˜í–‰í•œë‹¤ë©´ loop closure residualì— ëŒ€í•´ì„œëŠ” ë‚®ì€ noise (==ë†’ì€ ì‹ ë¢°ë„) ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆê² ë‹¤.</li>
                </ul>
              </li>
              <li>ë˜í•œ loop closure factor ë¥¼ ì¶”ê°€í•˜ê¸° ì´ì „ì—, loop closure detection (or aka place recognition) ì´ë¼ëŠ” ê³¼ì •ì„ ìˆ˜í–‰í•´ì•¼ í•˜ëŠ”ë°, ì´ê²ƒì´ 100% í•­ìƒ ì˜¬ë°”ë¥´ë‹¤ëŠ” <a href="https://threadreaderapp.com/thread/1443044133937942533.htmlj">ë³´ì¥ì´ ì—†ë‹¤</a>. ë”°ë¼ì„œ odometry factor ì™€ ë‹¬ë¦¬ loop closure factor ì— ëŒ€í•´ì„œëŠ” robust kernel ì„ ì”Œì›Œì£¼ëŠ” ì‘ì—… ë“±ì´ ìš”êµ¬ë˜ê¸°ë„ í•œë‹¤.
                <ul>
                  <li><a href="https://github.com/gisbi-kim/SC-A-LOAM/blob/main/src/laserPosegraphOptimization.cpp#L298">ì—¬ê¸°ì—ì„œ GTSAMì˜ Cauchy kernel ì„ ì‚¬ìš©í•œ ì˜ˆì œ</a> ë¥¼ ì°¸ê³ ë°”ëŒ.</li>
                </ul>
              </li>
            </ul>
          </li>
          <li>ë”°ë¼ì„œ í”„ë™í‹°ì»¬í•˜ê²ŒëŠ” loop closure factor ì™€ odometry factor ë¥¼ ë¶„ë¦¬í•´ì„œ ìƒê°í•˜ëŠ” í¸ì´ ì¢‹ë‹¤.</li>
        </ul>
      </li>
    </ol>
  </li>
  <li>ì„¤ëª… 2
    <ul>
      <li>ìœ„ì˜ ì½”ë“œë¥¼ ë³´ë©´ $\text{SE}(3)$ë¥¼ ì¸í’‹ìœ¼ë¡œ ë°›ì§€ë§Œ ì‹¤ì œë¡œ diffëŠ” local_coordinatesë¼ëŠ” í•¨ìˆ˜ë¥¼ í†µí•´ì„œ ê³„ì‚°ë˜ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.
        <ul>
          <li>SymForce ì˜ ì½”ë“œë¥¼ ëœ¯ì–´ë³´ë©´ Pose3ì— ëŒ€í•´ local_coordinates ì€ ì•„ë˜(<a href="https://symforce.org/_modules/sym/ops/pose3/lie_group_ops.html#LieGroupOps.local_coordinates">ì›ë³¸ë§í¬</a>)ì™€ ê°™ì´ êµ¬í˜„ë˜ì–´ ìˆë‹¤.
            <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="o">@</span><span class="nb">staticmethod</span>
  <span class="k">def</span> <span class="nf">local_coordinates</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">):</span>
      <span class="c1"># type: (sym.Pose3, sym.Pose3, float) -&gt; T.List[float]
</span>
      <span class="c1"># Total ops: 50
</span>
      <span class="c1"># Input arrays
</span>      <span class="n">_a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">data</span>
      <span class="n">_b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">data</span>

      <span class="c1"># Intermediate terms (4)
</span>      <span class="n">_tmp0</span> <span class="o">=</span> <span class="o">-</span><span class="n">_a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">_a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">_b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">_a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">_b</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
      <span class="n">_tmp1</span> <span class="o">=</span> <span class="n">_a</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">_b</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
      <span class="n">_tmp2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">epsilon</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">_tmp0</span> <span class="o">-</span> <span class="n">_tmp1</span><span class="p">))</span>
      <span class="n">_tmp3</span> <span class="o">=</span> <span class="p">(</span>
          <span class="mi">2</span>
          <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.0</span> <span class="k">if</span> <span class="o">-</span><span class="n">_tmp0</span> <span class="o">+</span> <span class="n">_tmp1</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">math</span><span class="o">.</span><span class="n">copysign</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">_tmp0</span> <span class="o">+</span> <span class="n">_tmp1</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
          <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">acos</span><span class="p">(</span><span class="n">_tmp2</span><span class="p">)</span>
          <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">_tmp2</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
      <span class="p">)</span>

      <span class="c1"># Output terms
</span>      <span class="n">_res</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">6</span>
      <span class="n">_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">_tmp3</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">_a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">_b</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">_a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">_b</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">_a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">_b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">_a</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">_b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
      <span class="n">_res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">_tmp3</span> <span class="o">*</span> <span class="p">(</span><span class="n">_a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">_b</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">_a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">_b</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">_a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">_a</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">_b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
      <span class="n">_res</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">_tmp3</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">_a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">_b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">_a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">_a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">_b</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">_a</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">_b</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
      <span class="n">_res</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">_a</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">_b</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
      <span class="n">_res</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">_a</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="n">_b</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
      <span class="n">_res</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">_a</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="n">_b</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
      <span class="k">return</span> <span class="n">_res</span>
</code></pre></div>            </div>
          </li>
          <li>ì—¬ê¸°ì„œ return ê°’ì€ ë‘ Pose3ì¸ a, bì˜ difference ì´ë©° 3-4-5 ì¸ë±ìŠ¤ê°€ translation ì°¨ì´ì— í•´ë‹¹í•˜ê³ , 0-1-2 ì¸ë±ìŠ¤ê°€ rotation ì°¨ì´ì— í•´ë‹¹í•œë‹¤.
            <ul>
              <li>ë§¤ë²ˆ ê²Œì‹œê¸€ì—ì„œ ì´ì•¼ê¸°í•˜ì§€ë§Œ rotation ì˜ minimal representationì€ 3-dim ì´ê¸° ë•Œë¬¸ì— â€¦
                <ul>
                  <li>ps. <a href="https://gisbi-kim.github.io/blog/2021/10/03/slam-textbooks.html">Rotation ê³µë¶€ìë£Œ ì¶”ì²œì€ ì—¬ê¸°</a> ë¥¼ ì°¸ê³ ë°”ëŒ.</li>
                </ul>
              </li>
            </ul>
          </li>
          <li><code class="language-plaintext highlighter-rouge">Total ops</code> ë¥¼ ëª…ê¸°í•œ ê²ƒë„ í¥ë¯¸ë¡œìš´ ë¶€ë¶„ì´ë‹¤. ì¦‰, ì € ì—°ì‚°ì´ Pose3ì— ëŒ€í•´ì„œ deterministic í•˜ê²Œ ìµœì í™”ë˜ì–´ ìˆë‹¤ëŠ” ëœ».</li>
        </ul>
      </li>
      <li>ì•„ë¬´íŠ¼ ìš°ë¦¬ê°€ ì•Œì•„ì•¼ í•  ê²ƒ í•œì¤„ìš”ì•½ì€, rotation matrixì€ vector space ê°€ ì•„ë‹ˆê¸° ë•Œë¬¸ì—, Pose3 (== $\text{SE}(3)$) type ì‚¬ì´ì˜ error ë¥¼ ê³„ì‚°í•˜ê³  ì‹¶ì„ ë•ŒëŠ” <code class="language-plaintext highlighter-rouge">local_coordinates</code> ë¼ëŠ” í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤ëŠ” ê²ƒì´ë‹¤.
        <ul>
          <li>ps. ì§€ë‚œ from scratch ê²Œì‹œê¸€ì—ì„œëŠ” minimal í•œ vector3 ì¸ rotvecì„ ë¨¼ì € ì •ì˜í•˜ê³ , ì´ë¥¼ ì´ìš©í•´ì„œ SO(3)ì¸ rotmatì„ ë§Œë“¤ì–´ì„œ ì¼ì—ˆë‹¤.
            <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">rotvec</span>   <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">V3</span><span class="o">.</span><span class="n">symbolic</span><span class="p">(</span><span class="s">"Theta"</span><span class="p">)</span> <span class="c1"># i.e., angle-axis parametrization
</span>    <span class="n">rotmat</span>   <span class="o">=</span> <span class="n">LieGroupOps</span><span class="o">.</span><span class="n">from_tangent</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">Rot3</span><span class="p">,</span> <span class="n">rotvec</span><span class="p">)</span> <span class="c1"># for debug, display(rotmat.to_rotation_matrix())
</span></code></pre></div>            </div>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h2 id="experiments-setting">Experiments Setting</h2>
<ul>
  <li>ì•”íŠ¼ ì‚¬ì„¤ì´ ê¸¸ì—ˆëŠ”ë° ì‹¤í—˜ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.</li>
</ul>

<h3 id="dataset-generation">Dataset generation</h3>
<ul>
  <li>ë¨¼ì € í† ì´ ë°ì´í„°ì…‹ì„ ì§ì ‘ ë§Œë“¤ì–´ë³´ì. ìì„¸í•œ ê±´ <a href="https://github.com/gisbi-kim/symforce-tutorials/blob/main/pgo/1_pgo3d_toy/pose_graph_opt_3d_toy.ipynb">ì½”ë“œë¥¼ ì°¸ê³  (ë§í¬)</a>ë°”ëŒ.</li>
  <li><code class="language-plaintext highlighter-rouge">move()</code> í•¨ìˆ˜ë¥¼ í†µí•´ ì •ë‹¤ê°í˜• ëª¨ì–‘ì˜ trajectoryë¥¼ êµ¬ì„±í•˜ëŠ” nê°œì˜ pose ë¥¼ ìƒì„±í•œë‹¤. ì˜ˆì‹œëŠ” ì•„ë˜ì™€ ê°™ë‹¤.</li>
</ul>
<p align="center">
     <img src="/assets/data/2022-07-31-pgo-toy/toy_data.png" width="900" />
</p>

<h3 id="hyper-parameter-setting">Hyper parameter setting</h3>
<ul>
  <li>PGOì—ì„œ hyper parameter ë¼ê³  í•˜ë©´ ìœ„ì—ì„œ ì´ì•¼ê¸°í•œ 3ì¢…ë¥˜ì˜ factors ì— ëŒ€í•œ noise ë¥¼ ê²°ì •í•˜ëŠ” ì¼ì´ ë˜ê² ë‹¤.</li>
  <li>ì´ ì˜ˆì œì—ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì´ êµ¬ì„±í•´ë³´ì•˜ë‹¤.
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">## noises 
</span>  <span class="n">prior_diagonal_sigmas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.001</span>
  <span class="n">odometry_diagonal_sigmas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span> 
  <span class="n">loop_diagonal_sigmas</span> <span class="o">=</span> <span class="n">odometry_diagonal_sigmas</span> <span class="o">*</span> <span class="mf">0.1</span>
</code></pre></div>    </div>
    <ol>
      <li>prior ì˜ ê²½ìš° ì–´ì§œí”¼ ì œì¼ ì²« ë…¸ë“œì—ë§Œ ë¶€ì—¬í•  ê²ƒì´ë©°, ì „ì²´ trajectory ê°€ í”ë“¤ë¦¬ì§€ ì•Šì•„ì•¼ í•˜ë¯€ë¡œ (==gauge problemì— ë¹ ì§€ì§€ ì•Šì•„ì•¼ í•˜ë¯€ë¡œ) ì•„ì£¼ ì‘ì€ ê°’ìœ¼ë¡œ ì„¤ì •í•˜ì˜€ë‹¤.</li>
      <li>odometry ëŠ” (radì™€ meter ë¼ëŠ” ë‹¨ìœ„ë¥¼ ê³ ë ¤í•˜ì—¬) ì ë‹¹í•œ ê°’ìœ¼ë¡œ ì„¤ì •í•˜ì˜€ë‹¤.
        <ul>
          <li>ps. ì´ ë•Œ ì´ ê°’ì€ stdì¼ìˆ˜ë„ ìˆê³  covariance (stdì˜ ì œê³±) ì¼ìˆ˜ë„ ìˆëŠ”ë°, libraryë§ˆë‹¤ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë¬¸ë§¥ìƒ íŒŒì•…í•˜ì—¬ì•¼ í•œë‹¤. ì˜ˆë¥¼ ë“¤ì–´ GTSAMì—ì„œëŠ” covariance ì´ë‹¤.
            <ul>
              <li>í•˜ì§€ë§Œ ê·¸ê²ƒë³´ë‹¤ ë” ì¤‘ìš”í•œ ê±´ ì–´ì§œí”¼ ì ì • ìŠ¤ì¼€ì¼ì€ ì‹¤í—˜ì ìœ¼ë¡œë„ íŒŒì•…í•˜ëŠ” ê²ƒì´ ìš”êµ¬ëœë‹¤.</li>
              <li>ì´ ì˜ˆì œì—ì„œëŠ” ì•ì„œ <code class="language-plaintext highlighter-rouge">sfT.cast(sf.V6, sf.M.diag(diagonal_sigmas.to_flat_list()).inv() * sf.V6(tangent_error))</code> ì™€ ê°™ì´ error ì— noise ì˜ inverse ë¥¼ ë°”ë¡œ ê³±í•´ì£¼ëŠ” í˜•íƒœë¡œ êµ¬í˜„ë˜ì—ˆë‹¤.
                <ul>
                  <li>ì¦‰, stdê°€ ëœë‹¤. ì•„ë˜ ìˆ˜ì‹ì„ ì°¸ê³ í•˜ë©´ ì´í•´ê°€ ëœë‹¤. (ì¶œì²˜: Factor Graphs for Robot Perception, 2017). error $e$ì— ë°”ë¡œ (ì—­ìˆ˜ê°€)ê³±í•´ì§€ëŠ” ê²ƒì€ covariance ì˜ sqrtì„ì„ ì•Œ ìˆ˜ ìˆë‹¤. ê·¸ë˜ì„œ ì•ì„œ êµ¬í˜„ì—ì„œë„ ë³€ìˆ˜ ì´ë¦„ì„ diagonal_<code class="language-plaintext highlighter-rouge">sigma</code> ë¼ê³  ì¹­í•´ë‘ì—ˆë‹¤.</li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
        <p align="center">
       <img src="/assets/data/2022-07-31-pgo-toy/cov_eq.png" width="700" />
   </p>
      </li>
      <li>loop closure ì˜ noise ëŠ” odometryë³´ë‹¤ ë” ì‘ê²Œ (ë” ê°•ë ¥í•˜ê²Œ ì‘ìš©í•˜ë„ë¡) ì„¤ì •í•˜ì˜€ë‹¤.</li>
    </ol>
  </li>
</ul>

<h3 id="key-based-value-management">Key-based Value Management</h3>
<ul>
  <li>SymForce ê°€ ë˜ ì¢‹ì€ ì ì´ ë°”ë¡œ Key ê¸°ë°˜ìœ¼ë¡œ value ë¥¼ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ë‹¤.</li>
  <li>factorsë“¤ì„ ì‹¤ì œë¡œ ì„ ì–¸í•  ë•Œ ë‹¤ìŒê³¼ ê°™ì´ í•˜ë©´ ëœë‹¤.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 1/ Prior factors 
</span><span class="k">if</span> <span class="n">use_factors</span><span class="p">[</span><span class="s">'prior'</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_poses</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">continue</span>        
        <span class="c1"># only add at the first node 
</span>        <span class="n">factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Factor</span><span class="p">(</span>
            <span class="n">residual</span><span class="o">=</span><span class="n">prior_residual</span><span class="p">,</span>
            <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="n">f</span><span class="s">"poses[{i}]"</span><span class="p">,</span> <span class="n">f</span><span class="s">"poses_prior[{i}]"</span><span class="p">,</span> <span class="n">f</span><span class="s">"prior_diagonal_sigmas"</span><span class="p">],</span>
        <span class="p">))</span>

<span class="c1"># 2/ Odometry factors
</span><span class="k">if</span> <span class="n">use_factors</span><span class="p">[</span><span class="s">'odometry'</span><span class="p">]:</span>        
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_poses</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>        
        <span class="n">factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Factor</span><span class="p">(</span>
            <span class="n">residual</span><span class="o">=</span><span class="n">odometry_residual</span><span class="p">,</span>
            <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="n">f</span><span class="s">"poses[{i}]"</span><span class="p">,</span> <span class="n">f</span><span class="s">"poses[{i+1}]"</span><span class="p">,</span> <span class="n">f</span><span class="s">"odoms[{i}]"</span><span class="p">,</span> <span class="s">"odometry_diagonal_sigmas"</span><span class="p">],</span>
        <span class="p">))</span>

<span class="c1"># 3/ Loop factors
</span><span class="k">if</span> <span class="n">use_factors</span><span class="p">[</span><span class="s">'loop'</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">loops_index_pair</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">loops_indexes</span><span class="p">):</span>        
        <span class="n">idx_from</span> <span class="o">=</span> <span class="n">loops_index_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">idx_to</span> <span class="o">=</span> <span class="n">loops_index_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Factor</span><span class="p">(</span>
            <span class="n">residual</span><span class="o">=</span><span class="n">odometry_residual</span><span class="p">,</span>
            <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="n">f</span><span class="s">"poses[{idx_from}]"</span><span class="p">,</span> <span class="n">f</span><span class="s">"poses[{idx_to}]"</span><span class="p">,</span> <span class="n">f</span><span class="s">"loops[{ii}]"</span><span class="p">,</span> <span class="s">"loop_diagonal_sigmas"</span><span class="p">],</span>
        <span class="p">))</span>
</code></pre></div></div>

<ul>
  <li>ìœ„ì˜ ì½”ë“œì—ì„œ ë³´ë‹¤ì‹œí”¼, <code class="language-plaintext highlighter-rouge">residual=</code>ì— í•¨ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ê³ , <code class="language-plaintext highlighter-rouge">keys=</code> ì— ì´ í•¨ìˆ˜ì— ì¸ìë¡œ ë“¤ì–´ê°ˆ ë³€ìˆ˜ë“¤ì„ ì°¨ë¡€ë¡œ ë‚˜ì—´í•´ì£¼ë©´ ëœë‹¤.
    <ul>
      <li>ê·¸ëŸ°ë° ì´ stringfiedëœ ë³€ìˆ˜ì´ë¦„ë“¤ì€ ì–´ë””ì— ìˆëŠ”ê°€? ë‹¤ìŒê³¼ ê°™ì´ Values ë¼ëŠ” ê³³ì—ë‹¤ê°€ ë‹¤ ë‹´ì•„ì£¼ë©´ ëœë‹¤.
        <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">initial_values</span> <span class="o">=</span> <span class="n">Values</span><span class="p">(</span>
      <span class="c1"># poses=[sf.Pose3.identity()] * num_poses, # may not converge.
</span>      <span class="n">poses</span><span class="o">=</span><span class="n">initial_poses</span><span class="p">,</span>
            
      <span class="n">poses_prior</span><span class="o">=</span><span class="n">poses_prior</span><span class="p">,</span>
      <span class="n">prior_diagonal_sigmas</span><span class="o">=</span><span class="n">prior_diagonal_sigmas</span><span class="p">,</span>

      <span class="n">odoms</span><span class="o">=</span><span class="n">odoms_obs</span><span class="p">,</span>
      <span class="n">odometry_diagonal_sigmas</span><span class="o">=</span><span class="n">odometry_diagonal_sigmas</span><span class="p">,</span>
            
      <span class="n">loops</span><span class="o">=</span><span class="n">loops_obs</span><span class="p">,</span>
      <span class="n">loop_diagonal_sigmas</span><span class="o">=</span><span class="n">loop_diagonal_sigmas</span><span class="p">,</span>
  <span class="p">)</span>
</code></pre></div>        </div>
        <ul>
          <li>ìš°ë³€ì— ìˆëŠ” ê²ƒì´ ìš°ë¦¬ê°€ ì‚¬ì „ì— ì •ì˜í•´ë‘” ë³€ìˆ˜ë“¤ì´ë©°</li>
          <li>ì¢Œë³€ì— ì‚¬ìš©í•œ ì´ë¦„ì´ keyë¡œ ì“°ì´ê²Œ ëœë‹¤.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>ê·¸ëŸ¬ë©´ ìµœì¢…ì ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">Optimizer</code> classë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì€ ì‰½ë‹¤. ì•„ë˜ì™€ ê°™ì´ í•´ì£¼ë©´ ë!
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">optimizer</span> <span class="o">=</span> <span class="n">Optimizer</span><span class="p">(</span>
  <span class="n">factors</span><span class="o">=</span><span class="n">factors</span><span class="p">,</span>
  <span class="n">optimized_keys</span><span class="o">=</span><span class="p">[</span><span class="n">f</span><span class="s">"poses[{i}]"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_poses</span><span class="p">)],</span>
  <span class="n">debug_stats</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>    </div>
    <ul>
      <li>ì—¬ê¸°ì„œëŠ” ìµœì í™”í•  ë³€ìˆ˜ì— ëŒ€í•œ keyë§Œ ë˜ ë„£ì–´ì£¼ê²Œ ë˜ëŠ”ë°, ì´ ë¶€ë¶„ì€ ì¢€ Pytorchì™€ ë‹®ì€ ê²ƒ ê°™ê¸°ë„ í•˜ë‹¤.</li>
    </ul>
  </li>
</ul>

<h2 id="results">Results</h2>
<ul>
  <li>ì‚¬ì„¤ì´ ë˜ ì—­ì‹œ ê¸¸ì—ˆëŠ”ë°, ê²°ê³¼ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.</li>
</ul>

<h3 id="without-a-loop-constraint">Without a Loop constraint</h3>
<ul>
  <li>odometry factors ì— ëŒ€í•´ ground-truth ëŒ€ë¹„ perturbation noise ë¥¼ ì„ì–´ì£¼ì—ˆê¸° ë•Œë¬¸ì— (see <code class="language-plaintext highlighter-rouge">perturb_alpha</code> in the codes), loop closure factor ì—†ì´ëŠ” ì•„ë˜ì™€ ê°™ì´ trajectoryì— drift ê°€ ëˆ„ì ë˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.</li>
</ul>
<p align="center">
     <img src="/assets/data/2022-07-31-pgo-toy/result_odom.png" width="500" />
</p>

<h3 id="with-only-a-single-loop-constraint">With only a single Loop constraint</h3>
<ul>
  <li>í•œí¸, ì²˜ìŒ ë…¸ë“œì™€ ë§ˆì§€ë§‰ ë…¸ë“œ ì‚¬ì´ì— loop closure factor ë¥¼ ë‹¨ í•˜ë‚˜ë§Œ ë„£ì–´ì£¼ë”ë¼ë„, ì•„ë˜ì™€ ê°™ì´ ì „ì²´ trajectoryì˜ shape ì´ ë§ì´ ê°œì„ ë˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.</li>
</ul>
<p align="center">
     <img src="/assets/data/2022-07-31-pgo-toy/result_lc.png" width="500" />
</p>

<ul>
  <li>ì‚¬ì‹¤ ìˆ˜í•™ì ìœ¼ë¡œ ë‹¹ì—°í•œ ê²°ê³¼ì´ë‹¤ã…ã… ê·¸ë˜ë„ ìƒˆë¡œìš´ íˆ´ì„ ì´ìš©í•´ì„œ ê°„ë‹¨í•˜ê²Œ ì´ë ‡ê²Œ ì‹¤ìŠµí•´ë³´ëŠ” ê²ƒì€ ì°¸ ì¬ë¯¸ìˆë‹¤.
    <ul>
      <li>ì´ëŸ° ë¥˜ì˜ (ê½¤ ì‘ì€ ì½”ë“œë² ì´ìŠ¤ ê·œëª¨ì˜) PGO ëŠ” SLAMê³„ì˜ hello-world ë¼ê³  í•  ìˆ˜ ìˆì§€ ì•Šì„ê¹Œ?</li>
    </ul>
  </li>
</ul>

<h1 id="ê²°ë¡ ">ê²°ë¡ </h1>
<ul>
  <li>SymForce ë¡œ Pose-graph Optimization ì„ ìˆ˜í–‰í•´ë³´ì•˜ë‹¤.
    <ul>
      <li>Pose3 ë“¤ì— ëŒ€í•´ unary (prior factor) or binary (between factor) constraints ë¥¼ ê±¸ì–´ì£¼ê¸° ìœ„í•´ì„œ, measurement ì™€ estimated (direct value or error value) ì‚¬ì´ì— error ë¥¼ ê³„ì‚°í•´ì•¼ í•œë‹¤. ì´ë¥¼ ê³„ì‚°í•˜ê¸° ìœ„í•´ì„œ local_coordinates ì´ë¼ëŠ” í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•œë‹¤. ì´ëŸ° í”„ë¡œì„¸ìŠ¤ë¥¼ <code class="language-plaintext highlighter-rouge">tangent space optimization</code> ë¼ê³ ë„ ë¶€ë¥¸ë‹¤.</li>
    </ul>
  </li>
  <li>ps. ê·¸ ì™¸ì—.. simularity ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ epsilonì„ ì˜ ì‚¬ìš©í•´ì£¼ì–´ì•¼ í•œë‹¤.</li>
</ul>

<h2 id="todo">TODO</h2>
<ul>
  <li>ì§ì ‘ ì œì‘í•œ toy example ì— ëŒ€í•´ì„œ í•´ë³´ì•˜ìœ¼ë‹ˆ, <a href="https://lucacarlone.mit.edu/datasets/">SLAM ë…¼ë¬¸ë“¤ì—ì„œ ë§ì´ ì“°ì´ëŠ” ë°ì´í„°ì…‹</a> ì— ëŒ€í•´ì„œë„ ì‹¤í—˜ì„ í•´ë³´ì.
    <ul>
      <li>ì´ ë•Œ ì˜ëª»ëœ (ì‚¬ì‹¤ì€ loopê°€ ì•„ë‹Œë°) loop closure factors ë“¤ì´ ë§ì´ ì‚½ì…ë  ë•Œ, <a href="https://github.com/gisbi-kim/toy-robust-backend-slam">ì–´ë–»ê²Œ ë°©ì–´í•  ìˆ˜ ìˆëŠ”ì§€</a> ì•Œì•„ë³´ì.</li>
    </ul>
  </li>
</ul>


  </div>

  <hr style="border:1px foo rgb(193, 198, 200)"><div id="disqus_thread" style="margin-top:25px"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'http://localhost:4000/slam/2022/07/31/pgo-toy.html';
      this.page.identifier = 'http://localhost:4000/slam/2022/07/31/pgo-toy.html';
    };
    (function () {
      var d = document, s = d.createElement('script');
      s.src = 'https://robotics.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments
      powered by Disqus.</a></noscript></div>

    </section>
    <footer class="condensed">
      <ul class="social about-footer condensed"><a href="https://www.linkedin.com/in/giseop-kim-71683088" target="_blank">
          <li>
            <i class="icon-linkedin-squared"></i>
          </li>
        </a><a href="https://scholar.google.com/citations?user=9mKOLX8AAAAJ&hl=ko&oi=ao" target="_blank">
          <li>
            <i class="ai ai-google-scholar"></i>
          </li>
        </a><a href="https://github.com/gisbi-kim" target="_blank">
          <li>
            <i class="icon-github-circled"></i>
          </li>
        </a><a href="https://bit.ly/giseopkim" target="_blank">
          <li>
            <i class="fa fa-user" style="font-size: 2.09em;"></i>
            <!-- <i> notion</i> -->
            <!-- <i class="fa fa-user"></i> -->
          </li>
        </a><a href="https://youtube.com/channel/UCrmVMJ3KEFbDD9EtnAmDT6g" target="_blank">
          <li>
            <i class="icon-youtube"></i>
          </li>
        </a></ul><p class="about-footer condensed">&copy;
        2022</p><div class="about-footer condensed">
        <p>Dark Mode
          <i class="icon-moon"></i>
          <label class="switch">
            <input type="checkbox" class="dark-mode-toggle">
            <span class="slider round" onclick="toggleDarkMode()"></span>
          </label>
        </p>
      </div>
    </footer>
  </main>
  
  <script type="text/javascript" src="/assets/js/darkmode.js"></script>
  
  <script src="/assets/js/simple-jekyll-search.min.js"></script>
  <script src="/assets/js/search.js"></script>
  
</body>

</html>
