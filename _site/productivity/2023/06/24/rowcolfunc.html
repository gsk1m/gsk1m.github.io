<!DOCTYPE html>
<html lang="en">

<head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<link rel="stylesheet" href="/assets/css/style.css">
<link rel="stylesheet" href="/assets/css/academicons-1.9.2/css/academicons.css">
<link rel="stylesheet" href="/assets/css/fontawesome-free-6.1.1-web/css/all.css">
<link href="https://fonts.googleapis.com/css?family=Merriweather:300|Raleway:400,700" rel="stylesheet">

<title>🌈 Row-major, Column-major, 그리고 컴파일러 최적화</title>

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>🌈 Row-major, Column-major, 그리고 컴파일러 최적화 | Giseop Kim Blog</title>
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="🌈 Row-major, Column-major, 그리고 컴파일러 최적화" />
<meta name="author" content="Giseop Kim" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Compiler 가 해주는 것과 안해주는 것에 대해 알아보자 컴파일러 (와 ChatGPT)는 나의 동료다." />
<meta property="og:description" content="Compiler 가 해주는 것과 안해주는 것에 대해 알아보자 컴파일러 (와 ChatGPT)는 나의 동료다." />
<link rel="canonical" href="http://localhost:4000/productivity/2023/06/24/rowcolfunc.html" />
<meta property="og:url" content="http://localhost:4000/productivity/2023/06/24/rowcolfunc.html" />
<meta property="og:site_name" content="Giseop Kim Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-06-24T08:00:00+09:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="🌈 Row-major, Column-major, 그리고 컴파일러 최적화" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Giseop Kim"},"dateModified":"2023-06-24T08:00:00+09:00","datePublished":"2023-06-24T08:00:00+09:00","description":"Compiler 가 해주는 것과 안해주는 것에 대해 알아보자 컴파일러 (와 ChatGPT)는 나의 동료다.","headline":"🌈 Row-major, Column-major, 그리고 컴파일러 최적화","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/productivity/2023/06/24/rowcolfunc.html"},"url":"http://localhost:4000/productivity/2023/06/24/rowcolfunc.html"}</script>
<!-- End Jekyll SEO tag -->


<script type="text/javascript" src="/assets/js/darkmode.js"></script>


<!-- fabicon -->
<link rel="icon" type="image/png" href="/assets/icon/me.png">
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        TeX: {
          equationNumbers: {
            autoNumber: "AMS"
          }
        },
        tex2jax: {
        inlineMath: [ ['$', '$'] ],
        displayMath: [ ['$$', '$$'] ],
        processEscapes: true,
      }
    });
MathJax.Hub.Register.MessageHook("Math Processing Error",function (message) {
        alert("Math Processing Error: "+message[1]);
    });
MathJax.Hub.Register.MessageHook("TeX Jax - parse error",function (message) {
        alert("Math Processing Error: "+message[1]);
    });
</script>
<script type="text/javascript" async
    src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
    
</head><body>
  <main class="container">
    <section class="about">
      <div class="about-header condensed">
      <div class="about-title">
      <a href="/">
        
        <img src="/assets/giseopkim_thermal.png" alt="Giseop Kim" />
        
      </a>
      <h2 id="title">
        <a href="/">Giseop Kim</a>
      </h2>
      </div><p class="tagline">SLAM Engineer</p></div>
      
      <ul class="social about-footer condensed"><a href="https://www.linkedin.com/in/giseop-kim-71683088" target="_blank">
          <li>
            <i class="icon-linkedin-squared"></i>
          </li>
        </a><a href="https://scholar.google.com/citations?user=9mKOLX8AAAAJ&hl=ko&oi=ao" target="_blank">
          <li>
            <i class="ai ai-google-scholar"></i>
          </li>
        </a><a href="https://github.com/gisbi-kim" target="_blank">
          <li>
            <i class="icon-github-circled"></i>
          </li>
        </a><a href="https://bit.ly/giseopkim" target="_blank">
          <li>
            <i class="fa fa-user" style="font-size: 2.09em;"></i>
            <!-- <i> notion</i> -->
            <!-- <i class="fa fa-user"></i> -->
          </li>
        </a><a href="https://youtube.com/channel/UCrmVMJ3KEFbDD9EtnAmDT6g" target="_blank">
          <li>
            <i class="icon-youtube"></i>
          </li>
        </a></ul><p class="about-footer condensed">&copy;
        2024</p><div class="about-footer condensed">
        <p>Dark Mode
          <i class="icon-moon"></i>
          <label class="switch">
            <input type="checkbox" class="dark-mode-toggle">
            <span class="slider round" onclick="toggleDarkMode()"></span>
          </label>
        </p>
      </div>
    </section>
    <section class="content">
      <div class="post-container">
  <a class="post-link" href="/productivity/2023/06/24/rowcolfunc.html">
    <h2 class="post-title">🌈 Row-major, Column-major, 그리고 컴파일러 최적화</h2>
  </a>
  <hr style="border:1px foo rgb(193, 198, 200)">
  <div class="post-meta">
    <div class="post-date"><i class="icon-calendar"></i>Jun 24, 2023</div><ul class="post-categories"><li>Productivity</li></ul></div>
  <div class="post">
    <h1 id="compiler-가-해주는-것과-안해주는-것에-대해-알아보자">Compiler 가 해주는 것과 안해주는 것에 대해 알아보자</h1>
<ul>
  <li>컴파일러 (와 ChatGPT)는 나의 동료다.</li>
</ul>

<h2 id="개요">개요</h2>
<ul>
  <li>일반적인 코딩 팁 같은 이야기는 인터넷에 이미 많으므로 원래 잘 안쓰려고 하지만 …
    <ul>
      <li>나름대로 실험해본 바가 있어 기록 차원에서 정리해두려고 한다.</li>
    </ul>
  </li>
</ul>

<h2 id="문제-상황">문제 상황</h2>
<ul>
  <li>Matrix 가 있을 때 익숙히 알려진 꿀팁이
    <ul>
      <li>Matrix 전체 elmenet 들을 순회하려면 for loop 두번을 돌아야 하는데,</li>
      <li>이 때 row-major 가 column-major 보다 성능이 좋다는 것이다.</li>
    </ul>
  </li>
</ul>

<h2 id="배경-지식">배경 지식</h2>
<ul>
  <li>왜 그런지는 관련 자료는 많으므로 키워드만 정리하고 넘어간다 <del>자세한 설명은 생략한다</del> .
    <ul>
      <li>키워드: <code class="language-plaintext highlighter-rouge">Cache Locality</code>, <code class="language-plaintext highlighter-rouge">Cache Line</code>, <code class="language-plaintext highlighter-rouge">Cache Miss</code>
        <ul>
          <li>결국 Cache Cache Cache! 이게 matrix 순회 예제에 그치면 안되고, Cache Locality 라는 개념과 HW (<code class="language-plaintext highlighter-rouge">CPU</code> 와 <code class="language-plaintext highlighter-rouge">Memory</code> 구조)에 대해 전체적으로 이해하고 넘어가야 실제로 공부를 한 것이라고 할 수 있겠다.</li>
        </ul>
      </li>
      <li>추천 자료
        <ul>
          <li><a href="https://onestepcode.com/array-reference-performance-row-major-vs-column-major-order/">Evaluating array reference performance: row-major vs. column-major order</a></li>
          <li><a href="https://levelup.gitconnected.com/c-programming-hacks-4-matrix-multiplication-are-we-doing-it-right-21a9f1cbf53">The impact of cache locality on performance in C through matrix multiplication</a></li>
          <li><a href="https://www.youtube.com/watch?v=BP6NxVxDQIs&amp;t=2429s">CppCon 2016: Timur Doumler “Want fast C++? Know your hardware!”</a></li>
          <li><a href="https://www.youtube.com/watch?v=SbaiAQDUi9A">false sharing. 병렬 프로그램 필수 상식</a></li>
          <li><a href="https://tsyang.tistory.com/68">Data-oriented Design (데이터 지향 설계, DoD)</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h2 id="실습">실습</h2>
<h3 id="hands-on-experience">Hands-on Experience</h3>
<ul>
  <li>늘 강조하는 것: 그냥 읽어보고 그림만 보는 것과 직접 from-scratch로 구현해서 자기 데이터에서 실험해서 직접 run script 쳐서 직접 결과를 보는 것은 실습자 입장에서 천지 차이 이다.</li>
  <li>그러므로 직접해보자.</li>
</ul>

<h3 id="구현">구현</h3>
<ul>
  <li>코드
    <ul>
      <li><a href="https://github.com/gisbi-kim/cpp_study/blob/master/main_20230624_rowmajor_colmajor_and_functional.cpp">rowmajor_colmajor_and_functional.cpp</a></li>
    </ul>
  </li>
  <li>설명
    <ul>
      <li>다음과 같이 시간을 측정해주는 팩토리를 만들고
        <p align="center">
  <img src="/assets/data/2023-06-24-rowcolfunc/factory.png" width="560" />
</p>
      </li>
      <li>팩토리클래스에 다음과 같은 서로다른 3종의 람다함수머신들을 넣어주면 된다.
        <p align="center">
  <img src="/assets/data/2023-06-24-rowcolfunc/machines.png" width="900" />
</p>
      </li>
    </ul>
  </li>
</ul>

<h3 id="실행">실행</h3>
<ul>
  <li>실습환경
    <ul>
      <li>cpp web compiler 라고 치면 간단하게 실습해볼 수 있는 곳들이 많이 나온다.
        <ul>
          <li>나는 <a href="https://www.onlinegdb.com/online_c++_compiler">onlinegdb</a> 에 코드를 붙여넣기 해서 실행해보았다.</li>
        </ul>
      </li>
      <li>Tip
        <ul>
          <li>O3 로 build 하려면,
            <ul>
              <li>직접 리눅스 머신에서 실험한다면 <code class="language-plaintext highlighter-rouge">g++ -std=c++17 -O3 main.cpp -o main</code> 와 같이 빌드해주면 되고,</li>
              <li>위의 <a href="https://www.onlinegdb.com/online_c++_compiler">onlinegdb</a> 사이트에서 적용하려면 아래 그림과 같이 한 다음 OK누르고 실행 해주면 된다.
                <p align="center">
      <img src="/assets/data/2023-06-24-rowcolfunc/o3.png" width="700" />
</p>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h3 id="결과">결과</h3>
<ul>
  <li>matrix dimension SIZE를 달리해가며 실험하였다.</li>
  <li>결과는 다음과 같았다 (각 SIZE에 대해 1회씩만 측정하였다).
    <ul>
      <li>여기서 가로축의 Size 는 한 축의 dimension을 의미한다. 즉, SIZE=10000 이면, 10000 by 10000 matrix 를 순회하는 것이다.</li>
    </ul>
    <p align="center">
  <img src="/assets/data/2023-06-24-rowcolfunc/plot.png" width="800" />
</p>
  </li>
  <li>위 ablation study의 의도
    <ul>
      <li><strong>Question 1:</strong> row-major 와 column major 의 from-scratch 구현체 결과를 비교하였다. (see <code class="language-plaintext highlighter-rouge">파랑실선 &lt;=&gt; 빨강실선</code>)</li>
      <li><strong>Question 2:</strong> row-major의 from-scratch 구현체와 row-major 의 std::algorithmic(i.e., functional)한 구현체 결과를 비교하였다. (see <code class="language-plaintext highlighter-rouge">파랑실선 &lt;=&gt; 초록실선</code>)</li>
      <li><strong>Question 3:</strong> compiler optimization option (-O3) 을 안넣고 넣고 차이를 비교하였다 (see <code class="language-plaintext highlighter-rouge">실선 &lt;=&gt; 점선</code>)</li>
    </ul>
  </li>
</ul>

<h3 id="결과-해석">결과 해석</h3>
<ul>
  <li>Answer of Question 1:
    <ul>
      <li>당연히 익히 알고 있는대로 row-major 가 훨씬 빠르다  (see <code class="language-plaintext highlighter-rouge">파랑실선 &lt;=&gt; 빨강실선</code>).</li>
    </ul>
  </li>
  <li>Answer of Question 2:
    <ul>
      <li>std::algorithm을 최대한 활용하면 functional 한 디자인이 자연스럽게 강제됨으로써 유지보수성이 좋아진다. 그래서 우리는 최대한 std::algorithm을 활용하고 싶다.</li>
      <li>하지만 no optimization 환경에서는 raw 한 double nested loops 보다 느린 성능을 보여주었다 (see <code class="language-plaintext highlighter-rouge">파랑실선 &lt;=&gt; 초록실선</code>).
        <ul>
          <li>사실 n이 작을 때 (e.g., <code class="language-plaintext highlighter-rouge">~</code> SIZE=10000 =&gt; 10000*10000 회의 순회) 는 차이가 크지 않다.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Answer of Question 3:
    <ul>
      <li>-O3 옵션을 넣어주니 std::algorith을 활용한 functional한 code 가 (적어도 이 예제의 이 실험에서는) raw 한 nested for loop 보다 (조금이나마) 더 빨랐다.</li>
    </ul>
  </li>
</ul>

<h2 id="결론">결론</h2>
<h3 id="lessons">Lessons</h3>
<ul>
  <li>위의 결론으로부터 다음과 같은 레슨을 도출할 수 있겠다.
    <ol>
      <li>괜한 성능고민<del>아집</del>하지 말고 <code class="language-plaintext highlighter-rouge">std::algorithm</code>의 <code class="language-plaintext highlighter-rouge">functional</code> 한 interface를 최대한 활용하자.
        <ul>
          <li>코드의 readability, maintainability, and testability 를 확보하는 것이 더욱 중요하다.</li>
        </ul>
      </li>
      <li>그런 다음, 최적화를 위해서는 O3 등 컴파일러를 믿자 (컴파일러는 나의 동료! 버그도 찾아주고 성능도 올려준다).
        <ul>
          <li>휴먼리더블 코드의 구현이 어떻고 저떻고에 대한 토의를 아무리 해도 실제 구동과 다를 수 있다. 즉, 코드의 성능에 관해 이야기 하려면, 컴파일러 최적화 까지 적용된 것에 대해서에만 논의해야 의미가 있다.</li>
        </ul>
      </li>
      <li>그런데 애초에 설계 자체가 잘못되(==column-major)면 아무리 컴파일러를 믿어도 안 되는 것은 안 되는 것이다.<del>안돼 돌아가</del>
        <ul>
          <li>예를 들어, 위의 결과 그림에서, O3 optimization을 적용한 빨강점선은 opt 를 적용하지 않은 초록실선 결과보다 여전히 매우 느렸다.</li>
        </ul>
      </li>
      <li>따라서 HW를 이해하고 근원적으로 올바른 개념을 작성하는 것은 여전히 프로그래머의 몫이라고 할 수 있겠다.
        <ul>
          <li>HW에 대한 이해는 많은 것들이 추상화 되고 프로그래밍이 입문하기 점점 더 쉬워지는 요즘에도 여전히 중요하다.</li>
        </ul>
      </li>
      <li>그리고 측정하자!
        <ul>
          <li>측정한 것으로 논의해야 한다.</li>
        </ul>
      </li>
    </ol>
  </li>
  <li>ps.
    <ul>
      <li>벤치마크는 여러번 돌려봐야 하는데 이 포스팅에서는 편의상 1번만 수행하였다. 그리고 그 소요시간도 머신마다도 다를 수 있다. 경향만 참고를 하자. 게다가 위에서는 onlinegdb라는 사이트에서 실행하였는데, 자원의 경쟁이 있는지..? 다른 시각에 같은 코드도 실행하니 엄청 더 느릴 때도 있었다.</li>
      <li>위의 matrix예제 같은 문제에서는 애초에 쌩으로 돌 생각보다는 <a href="https://en.cppreference.com/w/cpp/algorithm/execution_policy_tag_t">vectorization and parallel algorithms</a>을 고려하는 것이 좋을 것이다.</li>
      <li>그나저나 ChatGPT(4) 에게 <a href="https://github.com/gisbi-kim/cpp_study/blob/master/main_20230624_rowmajor_colmajor_and_functional.cpp#L1">위의 코드 주석에 있는 결과 서머리</a> 를 복사해서 주고 파이썬으로 비교 플롯 그려줘 라고 하고 색깔 정도만 지정해줬더니 위의 결과 plot을 그리는 파이썬 코드를 작성해주었다!! 불과 몇 개월만에 이제 신기하지않고 이정도는 이제 당연히 해주겠지? 라는 마음으로 적응해가고 있는 듯하다. 그리고 해준다!</li>
    </ul>
  </li>
</ul>


  </div>

  <hr style="border:1px foo rgb(193, 198, 200)"><div id="disqus_thread" style="margin-top:25px"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'http://localhost:4000/productivity/2023/06/24/rowcolfunc.html';
      this.page.identifier = 'http://localhost:4000/productivity/2023/06/24/rowcolfunc.html';
    };
    (function () {
      var d = document, s = d.createElement('script');
      s.src = 'https://robotics.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments
      powered by Disqus.</a></noscript></div>

    </section>
    <footer class="condensed">
      <ul class="social about-footer condensed"><a href="https://www.linkedin.com/in/giseop-kim-71683088" target="_blank">
          <li>
            <i class="icon-linkedin-squared"></i>
          </li>
        </a><a href="https://scholar.google.com/citations?user=9mKOLX8AAAAJ&hl=ko&oi=ao" target="_blank">
          <li>
            <i class="ai ai-google-scholar"></i>
          </li>
        </a><a href="https://github.com/gisbi-kim" target="_blank">
          <li>
            <i class="icon-github-circled"></i>
          </li>
        </a><a href="https://bit.ly/giseopkim" target="_blank">
          <li>
            <i class="fa fa-user" style="font-size: 2.09em;"></i>
            <!-- <i> notion</i> -->
            <!-- <i class="fa fa-user"></i> -->
          </li>
        </a><a href="https://youtube.com/channel/UCrmVMJ3KEFbDD9EtnAmDT6g" target="_blank">
          <li>
            <i class="icon-youtube"></i>
          </li>
        </a></ul><p class="about-footer condensed">&copy;
        2024</p><div class="about-footer condensed">
        <p>Dark Mode
          <i class="icon-moon"></i>
          <label class="switch">
            <input type="checkbox" class="dark-mode-toggle">
            <span class="slider round" onclick="toggleDarkMode()"></span>
          </label>
        </p>
      </div>
    </footer>
  </main>
  
  <script type="text/javascript" src="/assets/js/darkmode.js"></script>
  
  <script src="/assets/js/simple-jekyll-search.min.js"></script>
  <script src="/assets/js/search.js"></script>
  
</body>

</html>
